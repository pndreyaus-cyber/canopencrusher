# Описание файлов проекта

## Обзор
Эта папка содержит исходный код для системы управления роботом на момент окончания летней практики.
Работает
- отправка команд MAJ, MRJ, SCS
- Синхронизация осей

SCS нужна для программной установки текущего положения двигателей в 0, так как нет обработки входящих CAN сообщений

---

## Основные файлы приложения

### robot_6axis_working.ino
**Главная точка входа в приложение**
- Скетч Arduino, реализующий интерфейс управления роботом
- Разбирает команды через Serial (MAJ - Move Absolute, MRJ - Move Relative, ECH - Echo, SCS/SCU - Set Current Position)
- Инициализирует 6 осей и MoveController
- Основной цикл с обработкой входящих по Serial сообщениями

---

## Файлы управления осями

### Axis.h / Axis.cpp
**Управление и настройка отдельной оси**
- Определяет класс `Axis` для управления одной осью робота
- Управляет отслеживанием позиции (в шагах и единицах измерения, например, градусах)
- Обрабатывает преобразования координат между шагами и единицами измерения
- Реализует ограничения позиции (минимальные/максимальные границы)
- Предоставляет утилиты преобразования: шаги ↔ единицы, скорость ↔ об/мин
---

## Файлы управления движением

### MoveControllerBase.h / MoveControllerBase.cpp
**Контроллер координированного движения нескольких осей**
- Базовый класс для координации движения по нескольким осям
- Вычисляет скорости и ускорения для каждого из двигателя, чтобы поддерживать синхронизацию осей
- Использует шаблонные методы для работы с переменным количеством осей

### ControllerBase.h
**Базовая функциональность контроллера**
- ???

### CanOpenController.h
**Псевдонимы типов для удобства**
- Определяет упрощённые имена типов:
  - `Axis` → `StepDirController::Axis`
  - `MoveController` → `StepDirController::MoveControllerBase`

---

## Файлы связи CANopen

### CanOpen.h / CanOpen.cpp
**Реализация протокола CANopen**
- Реализует обмен сообщениями CANopen SDO (Service Data Object) и PDO (Process Data Object)
- Отправляет специфические команды управления двигателем:
  - `send_x260A_electronicGearMolecules` - настройка передаточного отношения
  - `send_x60FF_targetVelocity` - целевая скорость
  - `send_x6083_profileAcceleration` - профиль ускорения
  - `send_x6081_profileVelocity` - профиль скорости
  - `send_x6040_controlword` - управляющее слово двигателя
  - `send_x6060_modesOfOperation` - выбор режима работы
- Отправляет PDO4 для синхронизированных перемещений по позиции
- Отправляет сообщения SYNC для синхронизации
- Предоставляет метод `read()` для обработки полученных сообщений (TODO: реализовать)

### OD.h / OD.c
**Объектный словарь двигателей CANopen**
- Автоматически сгенерирован CANopenEditor из файла YZ_MOTOR.eds
- Определяет структуру словаря объектов CANopen
- Используется в качестве удобного хранения параметров дивгателей и других параметров (например, управляющее слово) в человекочитаемом виде, а не просто индексы в словаре
- **ВНИМАНИЕ: Не редактировать вручную - генерировать заново из EDS файла**

### objdict_objectdefines.h
**Определения индексов словаря объектов**
- Содержит макросы #define для индексов и подиндексов объектов CANopen
- Используется для ссылки на конкретные записи OD в коде

---

## Файлы драйвера CAN

### MyCanDriver.h
**Абстрактный интерфейс драйвера CAN**
- Чисто виртуальный базовый класс, определяющий интерфейс связи CAN
- Методы:
  - `send(id, data, len)` - отправить CAN-сообщение
  - `receive(id, data, len)` - принять CAN-сообщение
- Позволяет реализацию CAN независимо от платформы

### Stm32CanDriver.h / Stm32CanDriver.cpp
**Реализация драйвера CAN для STM32**
- Реализует интерфейс `MyCanDriver` для аппаратной части STM32
- Использует библиотеку STM32_CAN для низкоуровневого доступа к CAN
- Настраиваемая скорость передачи данных (по умолчанию: 1000000 бит/с / 1 Мбит/с)
---

## Конфигурация и параметры

### Params.h
**Структуры данных и перечисления**
- Перечисление `ParamsStatus`: OK, INCORRECT_COMMAND, INVALID_PARAMS
- Перечисление `CanResult`: Коды состояния для операций CAN
- Структура `MoveParams`: Параметры движения (6 осей, скорость, ускорение)
- Структура `PositionParams`: Данные позиции с node ID

### hal_conf_extra.h
**Конфигурация STM32 HAL**
- Включает модуль CAN (`HAL_CAN_MODULE_ENABLED`)
- Используется, чтобы работал и CAN и USB. По дефолту они на одном 
- Сам файл взят из репозитория STM32_CAN
---

## Обзор структуры проекта

```
Основное приложение
    └─ robot_6axis_working.ino

Уровень управления движением
    ├─ Axis (управление отдельной осью)
    ├─ ControllerBase (базовый контроллер)
    └─ MoveControllerBase (координированное движение)

Уровень связи
    ├─ CanOpen (протокол CANopen)
    ├─ MyCanDriver (абстрактный интерфейс)
    └─ Stm32CanDriver (реализация для STM32)

Конфигурация
    ├─ OD.h/c (словарь объектов)
    ├─ Params.h (структуры данных)
    └─ hal_conf_extra.h (конфигурация HAL)


```

---

## Основные зависимости

- **STM32_CAN** - Библиотека периферии CAN для STM32
- **Arduino Framework** - Для STM32 (STM32duino)

---

## Примечания

- Проект предназначен для **управления 6-осевым роботом**
- Использует **протокол CANopen** (CiA 402 для приводов и управления движением)
- Поддерживает **координированные многоосевые движения** с синхронизацией
- **Последовательный интерфейс** для ввода/вывода команд
- Отслеживание позиции как в **шагах**, так и в **пользовательских единицах** (например, градусах)
- Доступны **колбэки** для событий жизненного цикла движения
